name: Build Preview

jobs:
  # 1. Build Android app for preview
  build_android_app:
    type: build
    env:
      EXPO_PUBLIC_APP_VARIANT: "preview"
    params:
      platform: android
      profile: preview

  # 2. Build iOS app for preview
  build_ios_app:
    type: build
    env:
      EXPO_PUBLIC_APP_VARIANT: "preview"
    params:
      platform: ios
      profile: preview

  # 3. Build iOS simulator app for preview
  build_ios_simulator_app:
    type: build
    env:
      EXPO_PUBLIC_APP_VARIANT: "preview"
    params:
      platform: ios
      profile: preview-simulator

  # 4. Notify Slack about Android build success
  send_notification_android:
    after: [build_android_app]
    steps:
      - name: Notify Android Build
        run: |
          set -e
          MSG="âœ… New Android PREVIEW build created.\n"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$MSG\", \"username\": \"EAS - WORKFLOWS\", \
            \"icon_url\": \"https://raw.githubusercontent.com/nyplex/bot-icons/main/expo-icon.png\", \
            \"channel\":\"task-wan\"}" \
            "$SLACK_WEBHOOK_URL"

  # 5. Notify Slack about iOS build success
  send_notification_ios:
    after: [build_ios_app]
    steps:
      - name: Notify iOS Build
        run: |
          set -e
          MSG="âœ… New iOS PREVIEW build created.\n"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$MSG\", \"username\": \"EAS - WORKFLOWS\", \
            \"icon_url\": \"https://raw.githubusercontent.com/nyplex/bot-icons/main/expo-icon.png\", \
            \"channel\":\"task-wan\"}" \
            "$SLACK_WEBHOOK_URL"

  # 6. Notify Slack about build failures
  send_notification_failure:
    after: [build_android_app]
    if: failure()
    steps:
      - name: Notify Build Failure
        run: |
          set -e
          MSG="ðŸš¨ Android Preview build has failed.\nPlease check the EAS dashboard for details."
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$MSG\", \"username\": \"EAS - WORKFLOWS\", \
            \"icon_url\": \"https://raw.githubusercontent.com/nyplex/bot-icons/main/expo-icon.png\", \
            \"channel\":\"task-wan\"}" \
            "$SLACK_WEBHOOK_URL"
  
  # 7. Notify Slack about iOS build failures
  send_notification_ios_failure:
    after: [build_ios_app]
    if: failure()
    steps:
      - name: Notify iOS Build Failure
        run: |
          set -e
          MSG="ðŸš¨ iOS Preview build has failed.\nPlease check the EAS dashboard for details."
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$MSG\", \"username\": \"EAS - WORKFLOWS\", \
            \"icon_url\": \"https://raw.githubusercontent.com/nyplex/bot-icons/main/expo-icon.png\", \
            \"channel\":\"task-wan\"}" \
            "$SLACK_WEBHOOK_URL"

  # 8. Notify Slack about iOS simulator build success
  send_notification_ios_simulator:
    after: [build_ios_simulator_app]
    steps:
      - name: Notify iOS Simulator Build
        run: |
          set -e
          MSG="âœ… New iOS Simulator PREVIEW build created.\n"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$MSG\", \"username\": \"EAS - WORKFLOWS\", \
            \"icon_url\": \"https://raw.githubusercontent.com/nyplex/bot-icons/main/expo-icon.png\", \
            \"channel\":\"task-wan\"}" \
            "$SLACK_WEBHOOK_URL"